# Docker Compose for Local Development
# This simplified version focuses on backend and frontend development
# Wine service can be added later after fixing architecture issues

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: wine-dev-db
    environment:
      POSTGRES_DB: wine_emulator
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: changeme123
    ports:
      - "5432:5432"
    networks:
      - wine-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: wine-dev-redis
    ports:
      - "6379:6379"
    networks:
      - wine-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # FastAPI Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: wine-dev-backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql+asyncpg://admin:changeme123@postgres:5432/wine_emulator
      - REDIS_URL=redis://redis:6379
      - WINE_SERVICE_URL=http://localhost:8080
      - SECRET_KEY=dev-secret-key-change-in-production
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - wine-network
    # Remove volumes for production-like testing
    # For live development, run uvicorn locally outside Docker
    restart: unless-stopped

  # Next.js Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      # Use default target (production stage)
    container_name: wine-dev-frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NEXT_PUBLIC_WINE_VNC_URL=http://localhost:5900
    depends_on:
      - backend
    networks:
      - wine-network
    # Production build - for dev with hot reload, run locally
    restart: unless-stopped

  # Wine Gaming Service (for Counter-Strike 1.6 and other games)
  wine-gaming:
    build:
      context: .
      dockerfile: Dockerfile.wine-gaming
    container_name: wine-dev-gaming
    ports:
      - "5900:5900"  # VNC port
      - "27015:27015/udp"  # CS 1.6 game port
    environment:
      - DISPLAY=:99
      - WINEPREFIX=/root/.wine
      - WINEARCH=win32
      - WINEDEBUG=-all
    volumes:
      - wine-games:/app/games
      - wine-prefix:/root/.wine
      # Uncomment the next line to mount CS 1.6 files from local folder
      # - ./cs16-files:/app/games/cs16:ro
    networks:
      - wine-network
    shm_size: '2gb'  # Shared memory for graphics
    # Security options for better compatibility
    cap_add:
      - SYS_PTRACE
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-x", "Xvfb"]
      interval: 30s
      timeout: 10s
      retries: 3

  # noVNC Web Interface for interactive gaming
  novnc:
    image: theasp/novnc:latest
    container_name: wine-dev-novnc
    ports:
      - "6080:8080"  # Web VNC interface
    environment:
      - DISPLAY_WIDTH=1280
      - DISPLAY_HEIGHT=960
      - VNC_SERVER=wine-gaming:5900
      - VNC_PASSWORD=haos
    depends_on:
      - wine-gaming
    networks:
      - wine-network
    restart: unless-stopped

networks:
  wine-network:
    driver: bridge

volumes:
  wine-games:
    driver: local
  wine-prefix:
    driver: local
