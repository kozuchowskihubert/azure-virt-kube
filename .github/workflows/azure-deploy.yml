name: Deploy Wine Emulator Platform to Azure via Terraform

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.gitignore'
      - '*.sh'
      - '*.c'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      destroy:
        description: 'Destroy infrastructure (true/false)'
        required: false
        default: 'false'

env:
  TF_VAR_app_name: wine-emulator-platform
  TF_VAR_location: "East US"
  TF_VAR_resource_group_name: wine-emulator-rg
  NODE_VERSION: '18.x'
  PYTHON_VERSION: '3.11'
  TERRAFORM_VERSION: '1.6.0'

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸš€ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}

    - name: ğŸ”‘ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ğŸ“ Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: ğŸ§ª Terraform Validate
      working-directory: ./terraform
      run: terraform validate

    - name: ğŸ“‹ Terraform Plan
      working-directory: ./terraform
      run: |
        terraform plan -no-color -out=tfplan
        terraform show -no-color tfplan > plan-output.txt

    - name: ğŸ’¬ Comment PR with Plan
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const plan = fs.readFileSync('./terraform/plan-output.txt', 'utf8');
          
          const output = `## ğŸ—ï¸ Terraform Plan
          
          \`\`\`terraform
          ${plan}
          \`\`\`
          
          **Environment:** \`${{ env.TF_VAR_app_name }}\`
          **Location:** \`${{ env.TF_VAR_location }}\`
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output.length > 65536 ? output.substring(0, 65000) + '\n\n...truncated...' : output
          });

  build-and-deploy:
    name: Build & Deploy to Azure
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: production
    
    steps:
    - name: ğŸš€ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
        terraform_wrapper: false

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ”§ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: './frontend/package-lock.json'

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ”‘ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ğŸ—ï¸ Deploy Infrastructure with Terraform
      working-directory: ./terraform
      run: |
        # Initialize Terraform
        terraform init
        
        # Validate configuration
        terraform validate
        
        # Plan deployment
        terraform plan -out=tfplan
        
        # Apply infrastructure changes
        if [[ "${{ github.event.inputs.destroy }}" == "true" ]]; then
          echo "ğŸ”¥ Destroying infrastructure..."
          terraform destroy -auto-approve
          exit 0
        else
          echo "ğŸš€ Applying infrastructure changes..."
          terraform apply -auto-approve tfplan
        fi

    - name: ğŸ“Š Get Terraform Outputs
      id: terraform-outputs
      working-directory: ./terraform
      run: |
        echo "acr-server=$(terraform output -raw container_registry_login_server)" >> $GITHUB_OUTPUT
        echo "acr-username=$(terraform output -raw container_registry_admin_username)" >> $GITHUB_OUTPUT
        echo "acr-password=$(terraform output -raw container_registry_admin_password)" >> $GITHUB_OUTPUT
        echo "wine-url=$(terraform output -raw wine_emulator_url)" >> $GITHUB_OUTPUT
        echo "api-url=$(terraform output -raw backend_api_url)" >> $GITHUB_OUTPUT
        echo "web-url=$(terraform output -raw frontend_web_url)" >> $GITHUB_OUTPUT

    - name: ğŸ³ Login to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ steps.terraform-outputs.outputs.acr-server }}
        username: ${{ steps.terraform-outputs.outputs.acr-username }}
        password: ${{ steps.terraform-outputs.outputs.acr-password }}

    - name: ğŸ“¦ Install frontend dependencies
      working-directory: ./frontend
      run: |
        npm ci
        npm run build

    - name: ğŸ Install backend dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ§ª Run tests
      working-directory: ./backend
      run: |
        python -m pytest tests/ --verbose || echo "No tests found, skipping..."

    - name: ğŸ—ï¸ Build and push Docker images
      env:
        ACR_SERVER: ${{ steps.terraform-outputs.outputs.acr-server }}
        COMMIT_SHA: ${{ github.sha }}
      run: |
        # Build Wine Gaming Container (ARM64 compatible)
        echo "ğŸ· Building wine-gaming image..."
        docker build --platform linux/amd64 \
          -t $ACR_SERVER/wine-gaming:$COMMIT_SHA \
          -t $ACR_SERVER/wine-gaming:latest \
          -f Dockerfile.wine-gaming .
        
        # Build Backend API
        echo "ğŸ”§ Building backend-api image..."
        docker build \
          -t $ACR_SERVER/backend-api:$COMMIT_SHA \
          -t $ACR_SERVER/backend-api:latest \
          ./backend
        
        # Build Frontend Web
        echo "ğŸ¨ Building frontend-web image..."
        docker build \
          -t $ACR_SERVER/frontend-web:$COMMIT_SHA \
          -t $ACR_SERVER/frontend-web:latest \
          ./frontend
        
        # Push all images
        echo "ğŸ“¤ Pushing images to ACR..."
        docker push $ACR_SERVER/wine-gaming:$COMMIT_SHA
        docker push $ACR_SERVER/wine-gaming:latest
        docker push $ACR_SERVER/backend-api:$COMMIT_SHA
        docker push $ACR_SERVER/backend-api:latest
        docker push $ACR_SERVER/frontend-web:$COMMIT_SHA
        docker push $ACR_SERVER/frontend-web:latest

    - name: ğŸ”„ Restart App Services
      run: |
        # Restart all App Services to pull latest images
        az webapp restart --name wine-emulator-platform --resource-group wine-emulator-rg &
        az webapp restart --name wine-emulator-platform-api --resource-group wine-emulator-rg &
        az webapp restart --name wine-emulator-platform-web --resource-group wine-emulator-rg &
        wait
        echo "âœ… All App Services restarted"

    - name: ğŸ” Health Check
      run: |
        echo "ğŸ¥ Performing health checks..."
        
        # Wait for services to start
        sleep 60
        
        # Check Wine Gaming Service
        echo "Checking Wine Gaming Service..."
        curl -f ${{ steps.terraform-outputs.outputs.wine-url }}/health || echo "Wine service not ready yet"
        
        # Check Backend API
        echo "Checking Backend API..."
        curl -f ${{ steps.terraform-outputs.outputs.api-url }}/health || echo "API service not ready yet"
        
        # Check Frontend Web
        echo "Checking Frontend Web..."
        curl -f ${{ steps.terraform-outputs.outputs.web-url }}/ || echo "Web service not ready yet"

    - name: ğŸ‰ Deployment Summary
      run: |
        echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment:** Production" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ Production URLs:" >> $GITHUB_STEP_SUMMARY
        echo "- **Wine Emulator (VNC):** ${{ steps.terraform-outputs.outputs.wine-url }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend API:** ${{ steps.terraform-outputs.outputs.api-url }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend Web:** ${{ steps.terraform-outputs.outputs.web-url }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ® Gaming Access:" >> $GITHUB_STEP_SUMMARY
        echo "- **VNC Connection:** vnc://wine-emulator-platform.azurewebsites.net:5900" >> $GITHUB_STEP_SUMMARY
        echo "- **VNC Password:** haos" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Infrastructure:" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource Group:** wine-emulator-rg" >> $GITHUB_STEP_SUMMARY
        echo "- **Container Registry:** ${{ steps.terraform-outputs.outputs.acr-server }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Location:** East US" >> $GITHUB_STEP_SUMMARY

    - name: ğŸš¨ Notify on Failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸš¨ Production Deployment Failed - ${context.sha.substring(0, 7)}`,
            body: `
            ## ğŸš¨ Deployment Failure Alert
            
            **Commit:** ${context.sha}
            **Workflow:** ${context.workflow}
            **Run ID:** ${context.runId}
            **Time:** ${new Date().toISOString()}
            
            The production deployment has failed. Please check the workflow logs and resolve the issue.
            
            **Quick Actions:**
            - Check Terraform logs for infrastructure issues
            - Verify Azure service principal permissions
            - Review Docker build logs
            - Check App Service deployment status
            
            **Rollback Command:**
            \`\`\`bash
            # Trigger rollback workflow
            gh workflow run azure-deploy.yml -f destroy=true
            \`\`\`
            
            Auto-generated by GitHub Actions ğŸ¤–
            `,
            labels: ['deployment', 'production', 'urgent', 'terraform']
          })

jobs:
  build-and-push-images:
    name: Build & Push Docker Images to ACR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    strategy:
      matrix:
        include:
          - service: backend
            dockerfile: backend/Dockerfile
            context: ./backend
            image: backend
            platform: linux/amd64
          - service: frontend
            dockerfile: frontend/Dockerfile
            context: ./frontend
            image: frontend
            platform: linux/amd64
          - service: wine-service
            dockerfile: wine-service/Dockerfile
            context: ./wine-service
            image: wine-service
            platform: linux/arm64
    
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: ğŸ”‘ Login to Azure Container Registry
        run: |
          az acr login --name ${{ env.ACR_NAME }}

      - name: ğŸ“¦ Build and push ${{ matrix.service }} image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: ${{ matrix.platform }}
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/${{ matrix.image }}:latest
            ${{ env.ACR_LOGIN_SERVER }}/${{ matrix.image }}:${{ github.sha }}
            ${{ env.ACR_LOGIN_SERVER }}/${{ matrix.image }}:v1.0.${{ github.run_number }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.title=wine-emulator-${{ matrix.service }}
            org.opencontainers.image.description=Wine Emulator Platform - ${{ matrix.service }}
            service.name=${{ matrix.service }}
            platform=${{ matrix.platform }}
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=v1.0.${{ github.run_number }}
          cache-from: type=registry,ref=${{ env.ACR_LOGIN_SERVER }}/${{ matrix.image }}:buildcache
          cache-to: type=registry,ref=${{ env.ACR_LOGIN_SERVER }}/${{ matrix.image }}:buildcache,mode=max

      - name: âœ… Image build summary
        run: |
          echo "### ğŸ“¦ ${{ matrix.service }} Image Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.ACR_LOGIN_SERVER }}/${{ matrix.image }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "**SHA:** \`${{ env.ACR_LOGIN_SERVER }}/${{ matrix.image }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ env.ACR_LOGIN_SERVER }}/${{ matrix.image }}:v1.0.${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** \`${{ matrix.platform }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  deploy-backend:
    name: Deploy Backend to Azure Container Apps
    needs: build-and-push-images
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸš€ Deploy Backend Container App
        run: |
          az containerapp update \
            --name wine-emulator-backend \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.ACR_LOGIN_SERVER }}/backend:${{ github.sha }} \
            --set-env-vars \
              DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              REDIS_URL="${{ secrets.REDIS_URL }}" \
              SECRET_KEY="${{ secrets.SECRET_KEY }}" \
              JWT_SECRET="${{ secrets.JWT_SECRET }}"

      - name: âœ… Backend deployment summary
        run: |
          BACKEND_URL=$(az containerapp show \
            --name wine-emulator-backend \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          
          echo "### âœ… Backend Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://$BACKEND_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.ACR_LOGIN_SERVER }}/backend:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

  deploy-frontend:
    name: Deploy Frontend to Azure Container Apps
    needs: [build-and-push-images, deploy-backend]
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ¨ Deploy Frontend Container App
        run: |
          BACKEND_URL=$(az containerapp show \
            --name wine-emulator-backend \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          
          WINE_URL=$(az containerapp show \
            --name wine-emulator-wine \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            -o tsv 2>/dev/null || echo "")
          
          az containerapp update \
            --name wine-emulator-frontend \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.ACR_LOGIN_SERVER }}/frontend:${{ github.sha }} \
            --set-env-vars \
              NEXT_PUBLIC_API_URL="https://${BACKEND_URL}" \
              NEXT_PUBLIC_WINE_VNC_URL="https://${WINE_URL}"

      - name: âœ… Frontend deployment summary
        run: |
          FRONTEND_URL=$(az containerapp show \
            --name wine-emulator-frontend \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          
          echo "### âœ… Frontend Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://$FRONTEND_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.ACR_LOGIN_SERVER }}/frontend:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

  deploy-wine-service:
    name: Deploy Wine Service to Azure Container Apps
    needs: build-and-push-images
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ· Deploy Wine Service Container App
        run: |
          az containerapp update \
            --name wine-emulator-wine \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.ACR_LOGIN_SERVER }}/wine-service:${{ github.sha }} \
            --set-env-vars \
              WINE_VERSION="${{ secrets.WINE_VERSION }}" \
              WINEARCH="${{ secrets.WINEARCH }}" \
              DISPLAY="${{ secrets.DISPLAY }}" \
              BOX86_NOBANNER="${{ secrets.BOX86_NOBANNER }}" \
              BOX64_NOBANNER="${{ secrets.BOX64_NOBANNER }}"

      - name: âœ… Wine Service deployment summary
        run: |
          WINE_URL=$(az containerapp show \
            --name wine-emulator-wine \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          
          echo "### âœ… Wine Service Deployed (ARM64)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://$WINE_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.ACR_LOGIN_SERVER }}/wine-service:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** \`linux/arm64\`" >> $GITHUB_STEP_SUMMARY
          echo "**Wine Arch:** \`${{ secrets.WINEARCH }}\` (x86 + x64 support)" >> $GITHUB_STEP_SUMMARY
          echo "**Translation:** Box86 + Box64 enabled" >> $GITHUB_STEP_SUMMARY

  deployment-summary:
    name: Deployment Summary
    needs: [deploy-backend, deploy-frontend, deploy-wine-service]
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ“Š Generate deployment summary
        run: |
          FRONTEND_URL=$(az containerapp show \
            --name wine-emulator-frontend \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          
          BACKEND_URL=$(az containerapp show \
            --name wine-emulator-backend \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          
          WINE_URL=$(az containerapp show \
            --name wine-emulator-wine \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          
          echo "## ğŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ Application URLs:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL | Platform |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¨ Frontend | https://$FRONTEND_URL | linux/amd64 |" >> $GITHUB_STEP_SUMMARY
          echo "| âš™ï¸ Backend API | https://$BACKEND_URL | linux/amd64 |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ· Wine Service | https://$WINE_URL | linux/arm64 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Container Images:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`${{ env.ACR_LOGIN_SERVER }}/frontend:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`${{ env.ACR_LOGIN_SERVER }}/backend:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Wine Service: \`${{ env.ACR_LOGIN_SERVER }}/wine-service:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš™ï¸ Configuration:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Wine Version: ${{ secrets.WINE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- Wine Architecture: ${{ secrets.WINEARCH }} (x86 32-bit + x64 64-bit)" >> $GITHUB_STEP_SUMMARY
          echo "- ARM64 Translation: Box86 + Box64" >> $GITHUB_STEP_SUMMARY
          echo "- Build: v1.0.${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ‰ Deployment complete
        run: |
          echo "âœ… All services deployed successfully!"
          echo "ğŸŒ Frontend: https://$(az containerapp show --name wine-emulator-frontend --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn -o tsv)"
