FROM scottyhardy/docker-wine:stable-8.0.2

# Switch to root for installation
USER root

# Prevent interactive prompts during build
ENV DEBIAN_FRONTEND=noninteractive

# Install X11, VNC, and gaming dependencies
RUN apt-get update && apt-get install -y \
    # X11 and VNC
    xvfb x11vnc fluxbox \
    # Audio support (already has PulseAudio but ensure it's installed)
    pulseaudio \
    # Graphics libraries
    mesa-utils libgl1-mesa-dri libgl1-mesa-glx \
    # Utilities
    curl unzip supervisor procps net-tools \
    # Fonts for better text rendering
    fonts-liberation fonts-dejavu \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Set up Wine environment
ENV WINEPREFIX=/root/.wine
ENV WINEARCH=win32
ENV DISPLAY=:99
ENV WINEDEBUG=-all

# Create directories
RUN mkdir -p /app/games/cs16 \
    /root/.wine \
    /tmp/.X11-unix \
    /var/log/supervisor

# Set up VNC password
RUN mkdir -p ~/.vnc && \
    x11vnc -storepasswd haos ~/.vnc/passwd

# Copy supervisor configuration
COPY wine-service/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Create startup script
RUN cat > /app/start.sh << 'EOF'
#!/bin/bash
set -e

echo "ðŸš€ Starting Wine Emulator Service..."

# Start Xvfb (Virtual X server)
echo "ðŸ“º Starting Xvfb on display :99..."
Xvfb :99 -screen 0 1280x960x24 -nolisten tcp &
sleep 2

# Start window manager
echo "ðŸªŸ Starting Fluxbox..."
DISPLAY=:99 fluxbox &
sleep 1

# Start PulseAudio
echo "ðŸ”Š Starting PulseAudio..."
pulseaudio --start --exit-idle-time=-1 2>/dev/null || true

# Start VNC server
echo "ðŸ–¥ï¸  Starting VNC server on port 5900..."
x11vnc -display :99 -forever -shared -rfbport 5900 -rfbauth ~/.vnc/passwd -noxdamage &

# Initialize Wine prefix
echo "ðŸ· Initializing Wine..."
wine wineboot --init 2>/dev/null || true
sleep 3

echo "âœ… Wine Emulator Service Ready!"
echo "ðŸ“¡ VNC available on port 5900 (password: haos)"
echo "ðŸŽ® Ready to launch games!"

# Keep container running
tail -f /dev/null
EOF

RUN chmod +x /app/start.sh

# Expose VNC port
EXPOSE 5900

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD pgrep -x Xvfb && pgrep -x x11vnc || exit 1

# Start supervisor or direct script
CMD ["/app/start.sh"]
