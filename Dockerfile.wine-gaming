# Use Ubuntu base with Wine for better ARM64 compatibility
FROM --platform=linux/amd64 ubuntu:20.04

# Switch to root for installation
USER root

# Prevent interactive prompts during build
ENV DEBIAN_FRONTEND=noninteractive

# Enable i386 architecture and install Wine with proper ARM64 support
RUN dpkg --add-architecture i386 && \
    apt-get update && apt-get install -y \
    # Essential system packages
    wget gnupg software-properties-common \
    # Add Wine repository
    && wget -O- https://dl.winehq.org/wine-builds/winehq.key | apt-key add - \
    && add-apt-repository 'deb https://dl.winehq.org/wine-builds/ubuntu/ focal main' \
    && apt-get update && apt-get install -y \
    # Wine with full compatibility
    winehq-stable \
    # X11 and VNC
    xvfb x11vnc fluxbox \
    # Audio support
    pulseaudio alsa-utils \
    # Graphics libraries
    mesa-utils libgl1-mesa-dri libgl1-mesa-glx \
    # Essential libraries for Wine
    libc6:i386 libstdc++6:i386 \
    # Utilities
    curl unzip supervisor procps net-tools wget p7zip-full \
    # Fonts
    fonts-liberation fonts-dejavu \
    # Cross-compiler for Windows executables
    mingw-w64 gcc-mingw-w64-i686 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create wine user for proper permissions
RUN useradd -m -s /bin/bash wineuser && \
    usermod -aG audio,video wineuser

# Set up Wine environment optimized for x86 emulation
ENV WINEPREFIX=/home/wineuser/.wine
ENV WINEARCH=win32
ENV DISPLAY=:99
ENV WINEDEBUG=-all
# Force x86 mode even on ARM64
ENV WINEDLLOVERRIDES="winemenubuilder.exe=d"
ENV WINESERVER_TIMEOUT=60

# Create directories and CS 1.6 game structure
RUN mkdir -p /app/games/cs16 \
    /root/.wine \
    /tmp/.X11-unix \
    /var/log/supervisor

# Copy CS 1.6 setup scripts
COPY setup-cs16.sh /app/games/setup-cs16.sh
COPY auto-setup-cs16.sh /app/games/auto-setup-cs16.sh
RUN chmod +x /app/games/setup-cs16.sh /app/games/auto-setup-cs16.sh

# Automated CS 1.6 Download and Setup
RUN cd /app/games && \
    echo "ðŸŽ® Running automated CS 1.6 setup..." && \
    bash auto-setup-cs16.sh

# Create CS 1.6 demo structure (replace with real files when available)
# This is now handled by auto-setup-cs16.sh script

# Add instructions for adding real CS 1.6 files
RUN echo "CS 1.6 SETUP INSTRUCTIONS" > /app/games/cs16/README_CS16.txt && \
    echo "=========================" >> /app/games/cs16/README_CS16.txt && \
    echo "" >> /app/games/cs16/README_CS16.txt && \
    echo "This container is ready for CS 1.6! To add your game files:" >> /app/games/cs16/README_CS16.txt && \
    echo "" >> /app/games/cs16/README_CS16.txt && \
    echo "METHOD 1 - Copy files to running container:" >> /app/games/cs16/README_CS16.txt && \
    echo "  docker cp ./your-cs16-files/ wine-dev-gaming:/app/games/cs16/" >> /app/games/cs16/README_CS16.txt && \
    echo "" >> /app/games/cs16/README_CS16.txt && \
    echo "Required: hl.exe, cstrike/, valve/, platform/ folders" >> /app/games/cs16/README_CS16.txt && \
    echo "" >> /app/games/cs16/README_CS16.txt && \
    echo "Launch: wine hl.exe -game cstrike -console +map de_dust2" >> /app/games/cs16/README_CS16.txt

# VNC password will be set in startup script since wineuser is created by base image at runtime

# Optional: Copy CS 1.6 files if they exist locally
# Uncomment the next line and place your CS 1.6 files in ./cs16-files/ folder
COPY cs16-files/ /app/games/cs16/

# Copy supervisor configuration
COPY wine-service/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Create startup script
RUN cat > /app/start.sh << 'EOF'
#!/bin/bash
set -e

echo "ðŸš€ Starting Wine Emulator Service..."

# Set up VNC password for wineuser
echo "ðŸ” Setting up VNC password..."
mkdir -p /home/wineuser/.vnc
x11vnc -storepasswd haos /home/wineuser/.vnc/passwd
chmod 600 /home/wineuser/.vnc/passwd

# Start Xvfb (Virtual X server)
echo "ðŸ“º Starting Xvfb on display :99..."
Xvfb :99 -screen 0 1280x960x24 -nolisten tcp &
sleep 2

# Start window manager
echo "ðŸªŸ Starting Fluxbox..."
DISPLAY=:99 fluxbox &
sleep 1

# Start PulseAudio
echo "ðŸ”Š Starting PulseAudio..."
pulseaudio --start --exit-idle-time=-1 2>/dev/null || true

# Start VNC server
echo "ðŸ–¥ï¸  Starting VNC server on port 5900..."
x11vnc -display :99 -forever -shared -rfbport 5900 -rfbauth /home/wineuser/.vnc/passwd -noxdamage &

# Initialize Wine prefix
echo "ðŸ· Initializing Wine..."
wine wineboot --init 2>/dev/null || true
sleep 3

echo "âœ… Wine Emulator Service Ready!"
echo "ðŸ“¡ VNC available on port 5900 (password: haos)"
echo "ðŸŽ® Ready to launch games!"

# Keep container running
tail -f /dev/null
EOF

RUN chmod +x /app/start.sh

# Expose VNC port
EXPOSE 5900

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD pgrep -x Xvfb && pgrep -x x11vnc || exit 1

# Start supervisor or direct script
CMD ["/app/start.sh"]
